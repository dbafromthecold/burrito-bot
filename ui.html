<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Burrito Bot</title>
  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJz48dGV4dCB5PScwLjllbScgZm9udC1zaXplPSc5MCc+8J+MrzwvdGV4dD48L3N2Zz4=">

  <style>
    :root {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    * { box-sizing: border-box; }

    body { margin: 0; padding: 2rem; background:#0b0c10; color:#f5f7fa; }
    .wrap { max-width: 820px; margin: 0 auto; }
    h1 { margin: 0 0 1rem; font-size: 1.8rem; }

    form, .card {
      background: #141821;
      border: 1px solid #242a36;
      border-radius: 14px;
      padding: 1rem;
    }

    label { display:block; font-size:.9rem; color:#cbd5e1; margin-bottom:.5rem; }

    input[type="text"] {
      width:100%;
      padding:.75rem .9rem;
      border:1px solid #2b3344;
      border-radius:10px;
      background:#0f131b;
      color:#e5e7eb;
    }

    .row {
      display:flex;
      gap:.75rem;
      margin-top:.75rem;
      align-items:center;
    }

    .row input[type="number"] {
      width:100px;
      padding:.55rem .6rem;
      border:1px solid #2b3344;
      border-radius:10px;
      background:#0f131b;
      color:#e5e7eb;
    }

    button {
      padding:.7rem 1rem;
      border:0;
      border-radius:10px;
      background:#3b82f6;
      color:white;
      cursor:pointer;
    }

    button:disabled { opacity:.6; cursor:not-allowed; }

    .results { margin-top:1rem; display:grid; gap:.75rem; }

    .item {
      background:#0f131b;
      border:1px solid #222838;
      border-radius:12px;
      padding:.75rem .9rem;
    }

    .kvs {
      display:flex;
      flex-wrap:wrap;
      gap:.5rem 1rem;
      margin-top:.35rem;
      font-size:.9rem;
      color:#cbd5e1;
    }

    .kv-block { flex-basis:100%; }
    .kv b { color:#e5e7eb; }

    .muted { color:#9aa4b2; font-size:.9rem; }
    .err { color:#fca5a5; white-space:pre-wrap; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>üåØ Welcome to the Burrito Bot</h1>

    <form id="f">
      <label for="q">Ask me a question!</label>
      <input id="q" name="q" type="text"
             placeholder="Where should I get tacos in Dublin?"
             required />

      <div class="row">
        <label for="k" class="muted">Number of Results</label>
        <input id="k" name="k" type="number" min="1" max="50" value="5" />
        <button id="go" type="submit">Search</button>
      </div>
    </form>

    <div id="out" class="results"></div>
  </div>

<script>
const f = document.getElementById('f');
const out = document.getElementById('out');
const btn = document.getElementById('go');

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;');
}

function render(items, answer) {
  out.innerHTML = '';

  // ---------- AI Answer ----------
  if (answer) {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML =
      '<div style="white-space:pre-wrap;">' +
      escapeHtml(answer) +
      '</div>';
    out.appendChild(card);
  }

  if (!items || !items.length) return;


  // ---------- Render Retrieved Rows ----------
  for (const r of items) {
    const div = document.createElement('div');
    div.className = 'item';

    const header = [];
    if (r.name) header.push('<b>' + escapeHtml(r.name) + '</b>');
    if (r.city) header.push('<span class="muted">in ' + escapeHtml(r.city) + '</span>');
    if (r.rating) header.push('<span class="muted">‚≠ê ' + escapeHtml(String(r.rating)) + '</span>');

    const kvs = Object.entries(r)
      // Hide grounding-only fields
      .filter(([k,_]) => {
        const key = k.toLowerCase();
        return key !== "combined_reviews" && key !== "metadata_text";
      })
      .map(([k,v]) => {
        if (!v) return '';

        const key = k.toLowerCase();

        if (key === "address" || key === "phone") {
          return `<div class="kv-block"><b>${k}:</b> ${escapeHtml(String(v))}</div>`;
        }

        if (key === "url") {
          const href = String(v);
          return `<div class="kv-block"><b>${k}:</b>
            <a href="${href}" target="_blank" rel="noopener">
              ${escapeHtml(href)}
            </a>
          </div>`;
        }
        return `<span><b>${k}:</b> ${escapeHtml(String(v))}</span>`;
      }).join('');

    div.innerHTML =
      (header.length ? header.join(' ') + '<br/>' : '') +
      '<div class="kvs">' + kvs + '</div>';

    out.appendChild(div);
  }
}

f.addEventListener('submit', async (e) => {
  e.preventDefault();
  btn.disabled = true;
  out.innerHTML = '<div class="muted">Thinking‚Ä¶</div>';

  const q = document.getElementById('q').value.trim();
  const k = parseInt(document.getElementById('k').value || '5', 10);

  try {
    const res = await fetch('/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question: q, top_k: k })
    });

    const data = await res.json();

    if (!res.ok) {
      out.innerHTML = '<div class="err">' + (data.error || JSON.stringify(data)) + '</div>';
    } else {
      render(data.citations || [], data.answer || '');
    }
  } catch (err) {
    out.innerHTML = '<div class="err">' + String(err) + '</div>';
  } finally {
    btn.disabled = false;
  }
});
</script>
</body>
</html>